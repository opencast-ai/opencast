generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MarketStatus {
  OPEN
  RESOLVED
}

enum MarketOutcome {
  UNRESOLVED
  YES
  NO
}

enum TradeSide {
  YES
  NO
}

model Agent {
  id            String    @id @default(uuid())
  createdAt     DateTime  @default(now())
  displayName   String?
  balanceMicros BigInt    @default(0)

  apiKeys   ApiKey[]
  positions Position[]
  trades    Trade[]
}

model House {
  id        String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  treasuryMicros BigInt @default(0)
}

model ApiKey {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  agentId String
  agent   Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  keyHash String @unique

  @@index([agentId])
}

model Market {
  id          String        @id @default(uuid())
  createdAt   DateTime      @default(now())
  title       String
  description String?
  closesAt    DateTime?

  status  MarketStatus  @default(OPEN)
  outcome MarketOutcome @default(UNRESOLVED)

  pool      MarketPool?
  positions Position[]
  trades    Trade[]
}

model MarketPool {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  marketId String @unique
  market   Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  // All amounts stored as micros (1 Coin = 1_000_000 micros) to avoid floats.
  // Note: exact FPMM invariants and pricing are implemented in code; schema stores pool state.
  collateralMicros BigInt
  yesSharesMicros  BigInt
  noSharesMicros   BigInt

  feeBps Int @default(100) // 1% = 100 bps
}

model Position {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agentId  String
  agent    Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  marketId String
  market   Market  @relation(fields: [marketId], references: [id], onDelete: Cascade)

  yesSharesMicros BigInt @default(0)
  noSharesMicros  BigInt @default(0)

  @@unique([agentId, marketId])
  @@index([marketId])
}

model Trade {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  agentId  String
  agent    Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  marketId String
  market   Market  @relation(fields: [marketId], references: [id], onDelete: Cascade)

  side TradeSide

  // Collateral spent by agent, plus fee charged (both in micros).
  collateralInMicros BigInt
  feeMicros          BigInt

  // Shares received (in micros of shares).
  sharesOutMicros BigInt

  // Pool state after trade (optional but useful for audit/debug).
  poolCollateralMicros BigInt
  poolYesSharesMicros  BigInt
  poolNoSharesMicros   BigInt

  @@index([agentId])
  @@index([marketId])
}
